---
title: Azure 仮想ネットワークでのリソースを直接やり取り入れ子になった仮想マシンの構成
description: 入れ子になった仮想化
keywords: windows 10、ハイパー v Azure
author: johncslack
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: f316f4c576eae6dd7c14de367e42012a3c724eac
ms.sourcegitcommit: a9ab01b718b065124829b05868955f40e9020071
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/11/2018
ms.locfileid: "8917734"
---
# <a name="configuring-nested-vms-to-communicate-directly-with-resources-in-an-azure-virtual-network"></a>Azure 仮想ネットワークでのリソースを直接やり取り入れ子になった仮想マシンの構成

元の展開と Azure で入れ子になったの仮想マシンの構成に関するガイダンス NAT スイッチでこれらの仮想マシンにアクセスすることが必要です。 これには、いくつかの制限が表示されます。

1. 入れ子になった仮想マシンのリソース オンプレミスにアクセスできない、または Azure 仮想ネットワーク内でします。
2. 内部設置型リソースまたは Azure 内のリソースによってのみアクセスできます入れ子になったの仮想マシン、NAT では、同じポートを共有できないのは、複数のゲストを意味します。

この文書は RRAS] を使用してあなたの展開を学びいくつかユーザーの定義のルート、および「浮動」アドレス空間に動作し、VNet Azure 内に直接展開仮想マシンのような通信仮想マシンの入れ子にできるようにするのにします。

前に、このガイドを起動してください。

1. 読み、[ガイダンスがここに示す](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/nested-virtualization)で入れ子になった仮想化、ネストする機能を持つ仮想マシンを作成し、それらの仮想マシンで hyper-v をインストールします。 過去の HYPER-V 役割を設定できません。
2. この記事で全体の実装よりも前。

このガイドでは、対象の環境についての次の前提条件。

1. ExpressRoute に接続されている、ハブ[ハブとスポーク トポロジ](https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/hub-spoke)で操作しています。
1. スポーク ネットワークには、これ広げるには 2 つの/24 サブネット 10.0.0.0/23 のアドレス空間が割り当てられます。
    * 10.0.0.0/24 – サブネット HYPER-V ホストが格納されています。
    * 10.0.1.0/24 –「浮動」サブネットになります。 このアドレス スペース、入れ子になった仮想マシンで使用され、オンプレミスへルーティング広告の処理が既に存在します。
    * スポーク VNet「スポーク」の名前がわかりやすくします。

1. ハブ ネットワーク IP 範囲は重要ではありませんが、その名前が「ハブ」であること。
1. 弊社 HYPER-V には、10.0.0.4/24 のアドレスが割り当てられます。
1. 10.0.0.10/24 にある DNS サーバーがある、これは、要件が、このチュートリアルであると仮定します。

## <a name="high-level-overview-of-what-were-doing-and-why"></a>いるとの高度な概要を行うと理由

* 背景: 入れ子になった仮想マシンは届きません DHCP 内部または外部スイッチを構成する場合でも、ホストに接続されている VNet から。 
  * これは、場合、HYPER-V ホストが DHCP を提供する必要があります。
* HYPER-V ホストによってだけを使用するための ip アドレスのブロックを割り当てます。  HYPER-V ホストは、VNet に現在割り当てられているリースの注意をホスト割り当てます IP 既に存在する状況を回避するために HYPER-V ホストをだけで、使用するための ip アドレスのブロックを割り当てるは必要があります。 これにより、重複する IP シナリオを回避することができます。 
  * 選択した ip アドレスのブロック内に存在し、HYPER-V ホスト VNet サブネットが対応しています。
  * 既存のサブネットに対応するようにし理由は、ExpressRoute を介して BGP 通知を処理します。 使用する HYPER-V ホストの IP 範囲をだけに適用されたはかどうかは、一連のクライアントを許可する静的ルートを作成する必要があるオンプレミス入れ子になったの仮想マシンで通信します。 これはないハード要件入れ子になったの仮想マシンの IP 範囲を構成するし、クライアントの HYPER-V ホストが必要なすべてのルートを作成し、可能性のあるわけではします。
* HYPER-V 内の内部のスイッチを作成し、し、割り当てることで、新しく作成されたインターフェイス DHCP を確保し、設定の範囲に含まれる IP アドレス。 次の IP アドレスは、入れ子になった仮想マシンの既定のゲートウェイとなるし、する内部スイッチと VNet 当社に接続されているホストの NIC の間にルーティングするために使用します。
* ホストで、ホストをルーターに変わりますルーティングとリモート アクセスの役割をインストールします。  これは、機能は、リソースのホストに外部と、入れ子になった仮想マシンの間の通信を許可する必要があります。
* その他のリソースにこれらの入れ子になった仮想マシンにアクセスする方法を判断することは表示されます。 これにより、入れ子になったの仮想マシンの内に存在する IP 範囲の静的ルートを含むユーザー定義のルーティング テーブルを作成することが必要です。 この静的ルートが hyper-v が、IP アドレスをポイントします。
* オンプレミスに由来クライアントは、入れ子になった仮想マシンに到達する方法を理解できるように、ゲートウェイ サブネットにこの UDR を配置するされます。
* その他のサブネット内に入れ子になったの仮想マシンへの接続が必要な Azure でこの UDR を配置することもされます。
* 複数の HYPER-V ホストの追加の「浮動」サブネットを作成し、UDR にその他の静的ルートを追加します。
* HYPER-V ホストの使用を停止するときに、削除/転用当社「浮動」サブネットとから UDR 当社は、その静的ルートを削除するかの場合は、最後の HYPER-V ホスト完全に削除する、UDR します。

## <a name="creating-our-virtual-switch"></a>仮想、スイッチを作成します。

1. PowerShell を管理モードで開きます。
2. 内部スイッチを作成します。 `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 新しく作成されたインターフェイス IP を割り当てます。 `New-NetIPAddress –IPAddress 10.0.1.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>インストールおよび DHCP を構成します。

*多数のユーザーは、まずしようとしている入れ子になった仮想化の作業を開始するときにこのコンポーネントを見逃します。 異なり社内で、ゲスト仮想マシンのネットワークに存在し、ホストから DHCP を受信できる場所で Azure 仮想マシンを入れ子になったする必要があります DHCP を通じて提供ホスト上で実行します。 か、静的 IP アドレスに割り当てる、ネストされた各仮想マシン スケーラブルではない必要があります。*

1. DHCP の役割をインストールします。 `Install-WindowsFeature DHCP -IncludeManagementTools`
2. DHCP スコープを作成します。 `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.1.2 -EndRange 10.0.1.254 -SubnetMask 255.255.255.0`
3. スコープの DNS とゲートウェイの既定のオプションを構成するには。 `Set-DhcpServerV4OptionValue -DnsServer 10.0.0.10 -Router 10.0.1.1`
    * 必ず有効な DNS サーバーを入力してください。 ここでは、サーバーがあるが、Windows の DNS を処理する 10.0.0.0/24 ネットワーク上に問題が発生します。

## <a name="installing-remote-access"></a>リモート アクセスをインストールします。

* サーバー マネージャーを開き、"役割の追加と機能] を選択します。
* "サーバーの役割] に移動するまでは、[次へ] を選択します。
* 「リモート アクセス」を確認し、"役割サービス] に移動するまでは、[「次へ」をクリックします。
* 「ルーティング」を確認、機能の追加""を選択し、"次へ] と [インストール] を選択します。 ウィザードを完了して、インストールが完了するを待ちます。

## <a name="configuring-remote-access"></a>リモート アクセスを構成します。

* サーバー マネージャーを開く、「ツール」を選択し、「ルーティングとリモート アクセス」を選択します。
* ルーティングとリモート アクセス管理パネルの右側にあるアイコンがその横にあるサーバー名を表示、これを右クリックして「を構成して有効にするルーティングとリモート アクセス」を選択します。
* ウィザードで"次へ] を選択し、[「次の 2 つのプライベート ネットワーク間はセキュリティで保護された接続」にリング ボタンをクリックして"次へ] を選択し、します。
* "No"次へ] を選択して「完了」を選択し、[ダイヤルアップ接続を使用するかどうかを求められたら、リング] ボタンを選択します。

## <a name="creating-a-route-table-within-azure"></a>Azure 内のルーティング テーブルを作成します。

奥行きの作成と管理 Azure 内の経路を読むよりは、[この記事](https://docs.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal)を参照してください。

* 移動するhttps://portal.azure.comします。
* 左上隅で、「リソースを作成する」を選択します。
* 検索フィールドで、「ルート テーブル」を入力し、ヒットを入力します。
* 上の結果がルート テーブルには、このオプションを選択し、[「作成」
* ルーティング テーブルの名前を今回はという「ルート-用の入れ子になった-仮想マシン」します。
* 同じサブスクリプションに存在する、HYPER-V ホストを選択することを確認します。
* 新しい設備グループを作成するか、または既存のものを選択しのルート テーブルを作成する領域が含まれる、HYPER-V ホスト同じ領域であることを確認します。
* 「作成」を選択します。

## <a name="configuring-the-route-table"></a>ルート テーブルを構成します。

* 作成したルート テーブルに移動します。 ポータルの上部にある検索バーからルート テーブルの名前を検索して、これを行うことができます。
* 選択した後にルーティング テーブルからの「ルート」にブレード内で移動します。
* "の追加] を選択します。
* ルートに名前を付けて、「入れ子になった仮想マシンの」とはしました。
* アドレスに接頭辞は、「フリー」サブネットの IP 範囲を入力します。 ここでは 10.0.1.0/24 でしょう。
* "次回ホップ type"、「仮想アプライアンス」を選択し、10.0.0.4、すると"OK"を選択し、HYPER-V ホストの IP アドレスを入力します。
* 今すぐブレード select「サブネット」内でこれは、「ルート」の下にあります。
* 「関連付け」を選択し、「ハブ」バーチャル ネットワークの選択"GatewaySubnet"を選択して"OK"を選択します。
* 上にある HYPER-V ホストも入れ子になったの仮想マシンにアクセスする必要があるその他の任意のサブネットとサブネットの同じ手順を実行します。

## <a name="conclusion"></a>まとめ

HYPER-V ホストを仮想マシン (場合によっては 32 ビット VM!) を展開するには、内部設置型からと Azure 内でアクセス可能なを今すぐはずです。