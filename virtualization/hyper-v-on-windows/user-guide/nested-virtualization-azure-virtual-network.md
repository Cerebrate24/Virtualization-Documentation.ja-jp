---
title: Azure Virtual Network のリソースと直接通信するように入れ子になった Vm を構成する
description: 入れ子になった仮想化
keywords: windows 10、hyper-v、Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: efd180c458457da1cea6b379e21ba3a37083d15a
ms.sourcegitcommit: 1ca9d7562a877c47f227f1a8e6583cb024909749
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/04/2019
ms.locfileid: "74910962"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>Azure 仮想ネットワーク内のリソースと通信するように入れ子になった Vm を構成する

Azure 内で入れ子になった仮想マシンをデプロイして構成する方法に関する最初のガイダンスでは、NAT スイッチを使用してこれらの Vm にアクセスする必要があります。 これにはいくつかの制限があります。

1. 入れ子になった Vm は、オンプレミスまたは Azure Virtual Network 内のリソースにアクセスできません。
2. オンプレミスのリソースまたは Azure 内のリソースは、NAT を介して入れ子になった Vm にのみアクセスできます。つまり、複数のゲストが同じポートを共有することはできません。

このドキュメントでは、RRAS、ユーザー定義ルート、発信 NAT 専用のサブネットを使用してゲストインターネットにアクセスできるようにするためのデプロイと、入れ子になった Vm が他の仮想マシンと同じように動作して通信できるようにするための "floating" アドレス空間について説明します。Azure 内の VNet に直接デプロイされます。

このガイドを開始する前に、次のことを行ってください。

1. 入れ子になった仮想化については、[こちらのガイダンス](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization)を参照してください。
2. 実装する前に、この記事全体をお読みください。

## <a name="high-level-overview-of-what-were-doing-and-why"></a>私たちが行っていることとその理由の概要
* 2つの Nic を持つ、入れ子に対応した VM を作成します。 
* 1つの NIC を使用して、入れ子になった Vm に NAT 経由のインターネットアクセスを提供し、その他の NIC を使用して内部スイッチからハイパーバイザー外部のリソースへのトラフィックをルーティングします。 各 NIC は、異なるサブネットを意味する別のルーティングドメインに存在する必要があります。
* これは、少なくとも3つのサブネットに Virtual Network が必要であることを意味します。 1つは NAT 用、もう1つは LAN ルーティング用、もう1つは使用されていませんが、入れ子になった Vm では "予約済み" です。 このドキュメントでサブネットに使用する名前は、"NAT"、"Hyper-v-LAN"、および "ゴースト" です。
* これらのサブネットのサイズは自由に決定できますが、いくつかの考慮事項があります。 "ゴースト" サブネットのサイズによって、入れ子になった Vm に割り当てられる Ip の数が決まります。 また、"NAT" サブネットと "Hyper-v-LAN" サブネットのサイズによって、ハイパーバイザーに使用する Ip の数が決まります。 そのため、ハイパーバイザーを1つまたは2つだけにすることを計画している場合は、技術的には非常に小さなサブネットを作成できます。
* バックグラウンド: 入れ子になった Vm は、内部または外部スイッチを構成している場合でも、ホストが接続されている VNet から DHCP を受信しません。 
  * これは、Hyper-v ホストが DHCP を提供する必要があることを意味します。
* Hyper-v ホストは、VNet で現在割り当てられているリースを認識していません。そのため、既に存在する IP がホストによって割り当てられる状況を回避するには、Hyper-v ホストだけが使用する IP ブロックを割り当てる必要があります。 これにより、重複する IP シナリオを回避できます。
  * 選択する Ip のブロックは、Hyper-v が含まれているのと同じ VNet 内のサブネットに対応します。
  * これを既存のサブネットに対応させる理由は、ExpressRoute 経由での BGP アドバタイズのバックを処理することです。 Hyper-v ホストで使用する IP 範囲を構成したばかりの場合、オンプレミスのクライアントが入れ子になった Vm と通信できるように、一連の静的ルートを作成する必要があります。 これは、入れ子になった Vm の IP 範囲を構成し、その範囲の Hyper-v ホストにクライアントを誘導するために必要なすべてのルートを作成できるため、これは難しい要件ではないことを意味します。
* Hyper-v 内に内部スイッチを作成してから、新しく作成したインターフェイスに、DHCP 用に設定した範囲内の IP アドレスを割り当てます。 この IP アドレスは、入れ子になった Vm の既定のゲートウェイになり、内部スイッチと、VNet に接続されているホストの NIC との間のルーティングに使用されます。
* ホストにルーティングとリモートアクセスの役割をインストールします。これにより、ホストがルーターになります。  これは、ホストの外部のリソースと入れ子になった Vm との間の通信を許可するために必要です。
* これらの入れ子になった Vm にアクセスする方法については、他のリソースを参照してください。 これには、入れ子になった Vm が存在する IP 範囲の静的ルートを含むユーザー定義のルートテーブルを作成することがあります。 この静的ルートは、Hyper-v の IP アドレスを指します。
* 次に、この UDR をゲートウェイサブネットに配置します。これにより、オンプレミスからのクライアントは、入れ子になった Vm に接続する方法を知ることができます。
* また、この UDR は、入れ子になった Vm への接続を必要とする Azure 内の他のサブネットにも配置されます。
* 複数の Hyper-v ホストの場合は、追加の "浮動" サブネットを作成し、UDR に静的ルートを追加します。
* Hyper-v ホストの使用を停止する場合は、"浮動" サブネットを削除/転用し、UDR からその静的ルートを削除します。これが最後の Hyper-v ホストの場合は、UDR を完全に削除します。

## <a name="creating-the-host"></a>ホストを作成する

VM 名、リソースグループなど、個人の好みに応じた構成値をすべて表示します。

1. Portal.azure.com に移動します。
2. 左上にある [リソースの作成] をクリックします。
3. 人気の列から "Window Server 2016 VM" を選択します。
4. [基本] タブで、入れ子になった仮想化に対応した VM サイズを選択してください。
5. [ネットワーク] タブに移動します。
6. 次の構成で新しい Virtual Network を作成します
    * VNet アドレス空間: 10.0.0.0/22
    * サブネット 1
        * 名前: NAT
        * アドレス空間: 10.0.0.0/24
    * サブネット 2
        * 名前: Hyper-v-LAN
        * アドレス空間: 10.0.1.0/24
    * サブネット 3
        * 名前: ゴースト
        * アドレス空間: 10.0.2.0/24
    * サブネット4
        * 名前: Azure Vm
        * アドレス空間: 10.0.3.0/24
7. VM の NAT サブネットが選択されていることを確認します。
8. [レビュー + 作成] にアクセスし、[作成] を選択します。

## <a name="create-the-second-network-interface"></a>2 つ目のネットワーク インターフェイスを作成する
1. VM のプロビジョニングが完了したら、Azure Portal 内でそれを参照します。
2. VM を停止する
3. 停止したら、[設定] の下にある [ネットワーク] にアクセスします。
4. "ネットワークインターフェイスの接続"
5. "ネットワークインターフェイスの作成"
6. 名前を付けます (名前を付ける必要はありませんが、覚えておいてください)。
7. サブネットに対して [Hyper-v-LAN] を選択します。
8. ホストが存在するものと同じリソースグループを選択していることを確認します。
9. 生成
10. 前の画面に戻り、新しく作成されたネットワークインターフェイスを選択して [OK] を選択します。
11. [概要] ウィンドウに戻り、前のアクションが完了した後に VM を再起動します。
12. 先ほど作成した2番目の NIC に移動します。前の手順で選択したリソースグループにあります。
13. [IP 構成] に移動し、[IP 転送] を [有効] に切り替えて、変更を保存します。

## <a name="setting-up-hyper-v"></a>Hyper-v のセットアップ
1. ホストにリモートで
2. 管理者特権の PowerShell プロンプトを開く
3. コマンド `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart` を実行します。
4. これにより、ホストが再起動されます
5. 残りのセットアップを続行するには、ホストに再接続してください

## <a name="creating-our-virtual-switch"></a>仮想スイッチを作成しています

1. 管理モードで PowerShell を開きます。
2. 内部スイッチを作成する: `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 新しく作成したインターフェイスに IP: `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"` を割り当てます。

## <a name="install-and-configure-dhcp"></a>DHCP のインストールと構成

*多くのユーザーが、最初に入れ子になった仮想化を使用しようとしているときに、このコンポーネントを見逃します。ゲスト Vm がホストが存在するネットワークから DHCP を受信するオンプレミスとは異なり、Azure の入れ子になった Vm は、実行されているホスト経由で DHCP を提供する必要があります。または、すべての入れ子になった VM に IP アドレスを静的に割り当てる必要があります。これは、スケーラブルではありません。*

1. DHCP 役割のインストール: `Install-WindowsFeature DHCP -IncludeManagementTools`
2. DHCP スコープの作成: `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. スコープの DNS および既定のゲートウェイオプションを構成するには、`Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 名前解決を機能させるには、有効な DNS サーバーを入力してください。 この例では、 [Azure の再帰 DNS](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances)を使用しています。

## <a name="installing-remote-access"></a>リモートアクセスのインストール

1. サーバーマネージャーを開き、[役割と機能の追加] を選択します。
2. "サーバーの役割" が表示されるまで [次へ] を選択します。
3. "リモートアクセス" を確認し、[役割サービス] に到達するまで [次へ] をクリックします。
4. [ルーティング] をオンにして、[機能の追加] を選択し、[次へ]、[インストール] の順に選択します。 ウィザードを完了し、インストールが完了するまで待ちます。

## <a name="configuring-remote-access"></a>リモートアクセスの構成

1. サーバーマネージャーを開き、[ツール] を選択し、[ルーティングとリモートアクセス] を選択します。
2. [ルーティングとリモートアクセス管理] パネルの左側には、サーバー名の横にアイコンが表示され、右クリックして、[ルーティングとリモートアクセスの構成と有効化] を選択します。
3. ウィザードで [次へ] を選択し、[カスタム構成] の [放射状] ボタンをオンにして、[次へ] を選択します。
4. "NAT" と "LAN ルーティング" を確認し、[次へ]、[完了] の順に選択します。 サービスを開始するよう求められた場合は、それを実行します。
5. 次に、"IPv4" ノードに移動し、[NAT] ノードが使用可能になるように展開します。
6. [NAT] を右クリックし、[新しいインターフェイス...] を選択します。[イーサネット] を選択します。 IP アドレスが "10.0.0.4" の最初の NIC です。
7. 次に、2番目の NIC を強制的に LAN トラフィックに送信するために、いくつかの静的ルートを作成する必要があります。 これを行うには、[IPv4] の下にある [静的ルート] ノードに移動します。
8. ここでは、次のルートを作成します。
    * ルート1
        * インターフェイス: イーサネット
        * 送信先: 10.0.0.0
        * ネットワークマスク: 255.255.255.0
        * ゲートウェイ: 10.0.0.1
        * メトリック: 256
        * 注: これをここに配置して、プライマリ NIC が独自のインターフェイスを経由するトラフィックに応答できるようにします。 これがない場合、次のルートによって NIC 1 が nic 2 に送信されるトラフィックが発生します。 これにより、非対称ルートが作成します。 10.0.0.1 は、Azure が NAT サブネットに割り当てる IP アドレスです。 Azure では、範囲内で使用可能な最初の IP が既定のゲートウェイとして使用されます。 そのため、NAT サブネットに 192.168.0.0/24 を使用していた場合、ゲートウェイは192.168.0.1 になります。 ルーティングでは、より具体的なルートを優先します。つまり、このルートは次のルートよりも優先されます。

    * ルート2
        * インターフェイス: イーサネット2
        * 送信先: 10.0.0.0
        * ネットワークマスク: 255.255.252.0
        * ゲートウェイ: 10.0.1.1
        * メトリック: 256
        * 注: これは、Azure VNet に送信されるトラフィックのすべてをキャッチするルートです。 これにより、2番目の NIC のトラフィックが強制的に送信されます。 入れ子になった Vm にアクセスする他の範囲のルートを追加する必要があります。 そのため、オンプレミスネットワークが 172.16.0.0/22 の場合、ハイパーバイザーの2番目の NIC からトラフィックを送信する別のルートを作成する必要があります。

## <a name="creating-a-route-table-within-azure"></a>Azure 内でのルートテーブルの作成

Azure 内でのルートの作成と管理について詳しくは、こちらの[記事](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal)をご覧ください。

1. https://portal.azure.com に移動します。
2. 左上隅にある [リソースの作成] を選択します。
3. 検索フィールドに「Route Table」と入力し、enter キーを押します。
4. 上位の結果は [ルートテーブル] になり、これを選択して [作成] を選択します。
5. ルートテーブルに名前を付けます。ここでは "Route-nested-Vm" という名前を付けます。
6. Hyper-v ホストが存在するのと同じサブスクリプションを選択していることを確認してください。
7. 新しいリソースグループを作成するか、既存のリソースグループを選択して、ルートテーブルを作成するリージョンが、Hyper-v ホストが存在するリージョンと同じであることを確認します。
8. [作成] を選択します。

## <a name="configuring-the-route-table"></a>ルートテーブルの構成

1. 先ほど作成したルートテーブルに移動します。 これを行うには、ポータルの上部中央にある検索バーからルートテーブルの名前を検索します。
2. ルートテーブルを選択したら、ブレード内から "ルート" に移ります。
3. [追加] を選びます。
4. ルートに名前を付けます。 "入れ子になった Vm" を使用します。
5. [アドレスプレフィックス] には、"浮動" サブネットの IP 範囲を入力します。 この場合、10.0.2.0/24 になります。
6. "次ホップの種類" として [仮想アプライアンス] を選択し、Hyper-v ホストの2番目の NIC の IP アドレス (10.0.1.4) を入力して、[OK] を選択します。
7. ブレード内から "サブネット" を選択すると、これは "ルート" のすぐ下になります。
8. [関連付け] を選択し、[入れ子になった楽しい] VNet を選択して、"Azure Vm" サブネットを選択し、[OK] を選択します。
9. この手順は、Hyper-v ホストが存在するサブネットと、入れ子になった Vm にアクセスする必要がある他のサブネットに対しても行います。 接続されている場合 

# <a name="end-state-configuration-reference"></a>終了状態の構成のリファレンス
このガイドの環境には以下の構成があります。 このセクションは、参照として使用するためのものです。

1. Azure Virtual Network 情報。
    * VNet の高レベル構成。
        * 名前: Nested-楽しい
        * アドレス空間: 10.0.0.0/22
        * 注: これは4つのサブネットで構成されます。 また、これらの範囲は石で設定されていません。 必要に応じて、お客様の環境に自由に対応できます。 

    * 最初のサブネットの高レベル構成。
        * 名前: NAT
        * アドレス空間: 10.0.0.0/24
        * 注: これは、Hyper-v がプライマリ NIC をホストしている場所です。 これは、入れ子になった Vm の送信 NAT を処理するために使用されます。 これは、入れ子になった Vm のインターネットへのゲートウェイになります。

    * 2番目のサブネットの高レベル構成。
        * 名前: Hyper-v-LAN
        * アドレス空間: 10.0.1.0/24
        * 注: Hyper-v ホストには、入れ子になった Vm と Hyper-v ホスト外部のインターネット以外のリソースとの間のルーティングを処理するために使用される2つ目の NIC があります。

    * 第3サブネットの高レベル構成。
        * 名前: ゴースト
        * アドレス空間: 10.0.2.0/24
        * 注: これは "浮動" サブネットになります。 アドレス空間は、入れ子になった Vm によって消費され、オンプレミスへのルートの提供情報を処理するために存在します。 実際には、このサブネットには Vm はデプロイされません。

    * 4番目のサブネットの高レベル構成。
        * 名前: Azure Vm
        * アドレス空間: 10.0.3.0/24
        * 注: Azure Vm を含むサブネット。

1. Hyper-v ホストの NIC 構成は次のとおりです。
    * プライマリ NIC 
        * IP アドレス: 10.0.0.4
        * サブネット マスク: 255.255.255.0
        * デフォルトゲートウェイ: 10.0.0.1
        * DNS: DHCP 用に構成されている
        * IP 転送が有効: いいえ

    * セカンダリ NIC
        * IP アドレス: 10.0.1.4
        * サブネット マスク: 255.255.255.0
        * デフォルトゲートウェイ: 空
        * DNS: DHCP 用に構成されている
        * IP 転送が有効: はい

    * Hyper-v が内部仮想スイッチ用に NIC を作成しました
        * IP アドレス: 10.0.2.1
        * サブネット マスク: 255.255.255.0
        * デフォルトゲートウェイ: 空

3. ルートテーブルには、1つの規則があります。
    * 規則 1
        * 名前: 入れ子になった Vm
        * 宛先: 10.0.2.0/24
        * 次ホップ: 仮想アプライアンス-10.0.1.4

## <a name="conclusion"></a>まとめ

これで、仮想マシン (32 ビットの VM を含む) を Hyper-v ホストにデプロイし、オンプレミスと Azure の間でアクセスできるようになります。
