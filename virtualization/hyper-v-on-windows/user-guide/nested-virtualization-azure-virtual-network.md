---
title: Azure 仮想ネットワーク内のリソースと直接通信するための入れ子になった VM の構成
description: 入れ子になった仮想化
keywords: Windows 10, Hyper-V, Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: 63007d21fcc046f384405c7d85143bfc576ecc07
ms.sourcegitcommit: 16ebc4f00773d809fae84845208bd1dcf08a889c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/24/2020
ms.locfileid: "81395755"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>Azure 仮想ネットワーク内のリソースと通信するために入れ子になった VM を構成する

これは、Azure 内で入れ子になった仮想マシンのデプロイと構成を行う方法に関する最初のガイダンスであり、これらの VM へのアクセスは、NAT スイッチ経由で行う必要があります。 これには、いくつかの制限事項があります。

1. 入れ子になった VM は、オンプレミスのリソースや Azure 仮想ネットワーク内のリソースにアクセスできません。
2. オンプレミスのリソースまたは Azure 内のリソースは、NAT 経由でのみ入れ子になった VM にアクセスできます。つまり、複数のゲストが同じポートを共有することはできません。

このドキュメントでは、RRAS、ユーザー定義ルート、ゲストのインターネット アクセスを可能にする送信 NAT 専用のサブネット、および入れ子になった VM が、Azure 内の VNet に直接デプロイされた他のすべての仮想マシンと同様に動作し、通信できるようにする "フローティング" アドレス空間を利用するデプロイについて段階的に説明します。

このガイドを開始する前に、以下のことを行ってください。

1. 入れ子になった仮想化についての、[ここで提供されているガイダンス](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization)をお読みください。
2. 実装の前に、この記事全体をお読みください。

## <a name="high-level-overview-of-what-were-doing-and-why"></a>しようとしていることの内容と理由の概要
* 2 つの NIC を備え、入れ子に対応する VM を作成します。 
* 1 つの NIC は、入れ子になった VM に NAT 経由のインターネット アクセスを提供するために使用し、別の NIC は、内部スイッチからハイパーバイザーの外部にあるリソースへのトラフィックをルーティングするために使用します。 各 NIC は、異なるルーティング ドメイン (サブネットが異なることを意味します) に存在する必要があります。
* これは、サブネットを少なくとも 3 つ持つ仮想ネットワークが必要になることを意味します。 1 つは NAT 用、もう 1 つは LAN ルーティング用、もう 1 つは未使用ですが、入れ子になった VM 用に "予約済み" です。 このドキュメントでサブネットに使用する名前は、"NAT"、"Hyper-V-LAN"、および "Ghosted" です。
* これらのサブネットのサイズはユーザーが自由に決められますが、いくつかの考慮事項があります。 "Ghosted" サブネットのサイズによって、入れ子になった VM のために用意する IP の数が決まります。 また、"NAT" サブネットと "Hyper-V-LAN" サブネットのサイズによって、ハイパーバイザーのために用意する IP の数が決まります。 そのため、ハイパーバイザーを 1 つまたは 2 つだけにすることを計画している場合、技術的には非常に小さなサブネットを作成できます。
* 背景:入れ子になった VM は、内部スイッチや外部スイッチを構成した場合でも、ホストの接続先の VNet から DHCP を "受信しません"。 
  * これは、Hyper-V ホストで DHCP を提供する必要があることを意味します。
* Hyper-V ホストは、VNet で現在割り当てられているリースを認識していません。そのため、既に存在する IP がホストによって割り当てられる状況を回避するには、Hyper-V ホストだけが使用する IP のブロックを割り当てる必要があります。 これで、IP が重複するシナリオを回避できます。
  * 選択する IP のブロックは、Hyper-V があるのと同じ VNet 内のサブネットに対応することになります。
  * これを既存のサブネットに対応させる理由は、ExpressRoute を経由して戻される BGP のアドバタイズを処理することです。 Hyper-V ホストで使用する IP 範囲を構成したばかりの場合は、オンプレミスのクライアントが、入れ子になった VM と通信できるようにする一連の静的ルートを作成する必要があります。 これは実際には、入れ子になった VM 用の IP 範囲を構成し、クライアントをその範囲の Hyper-V ホストに向けるために必要なすべてのルートを作成できるため、それが難しい要件ではないことを意味します。
* Hyper-V 内に内部スイッチを作成してから、新しく作成したインターフェイスに、DHCP 用に確保していた範囲内の IP アドレスを割り当てます。 この IP アドレスが、入れ子になった VM のデフォルト ゲートウェイになり、内部スイッチと、VNet に接続されているホストの NIC との間のルーティングに使用されます。
* ホストにルーティングとリモート アクセスの役割をインストールします。これにより、そのホストがルーターになります。  これは、ホスト外部のリソースと、入れ子になった VM との間の通信を可能にするために必要です。
* その他のリソースに、これらの入れ子になった VM にアクセスする方法を通知します。 このために、入れ子になった VM が存在する IP 範囲への静的ルートが記載された、ユーザー定義ルートのテーブルを作成する必要が生じます。 この静的ルートは、Hyper-V のための IP アドレスを指し示します。
* その後で、入れ子になった VM に到達する方法が、オンプレミスからのクライアントに分るように、この UDR をゲートウェイ サブネットに配置します。
* この UDR は、入れ子になった VM への接続を必要とする、Azure 内のその他すべてのサブネットにも配置します。
* 複数の Hyper-V ホストの場合は、追加の "フローティング" サブネットを作成し、UDR に静的ルートをもう 1 つ追加します。
* Hyper-V ホストの使用を停止する場合は、"フローティング" サブネットを削除または転用し、UDR からその静的ルートを削除します。または、これが最後の Hyper-V ホストである場合は、UDR を完全に削除します。

## <a name="creating-the-host"></a>ホストの作成

ここでは、VM 名やリソース グループなど、個人的な好みで決められる構成値はすべて、適当な値を指定してゆきます。

1. portal.azure.com に移動します
2. 左上の [リソースの作成] をクリックします
3. [人気順] 列から [Window Server 2016 VM] を選択します
4. [基本] タブで、必ず、入れ子になった仮想化に対応した VM サイズを選択します
5. [ネットワーク] タブに移動します
6. 以下の構成で新しい仮想ネットワークを作成します
    * VNet アドレス空間:10.0.0.0/22
    * サブネット 1
        * 名前:NAT
        * アドレス空間:10.0.0.0/24
    * サブネット 2
        * 名前:Hyper-V-LAN
        * アドレス空間:10.0.1.0/24
    * サブネット 3
        * 名前:Ghosted
        * アドレス空間:10.0.2.0/24
    * サブネット 4
        * 名前:Azure-VMs
        * アドレス空間:10.0.3.0/24
7. VM 用の NAT サブネットを選択したことを確認します
8. [確認と作成] に移動し、[作成] を選択します

## <a name="create-the-second-network-interface"></a>2 つ目のネットワーク インターフェイスの作成
1. VM のプロビジョニングが終了したら、Azure portal 内でそれを参照します
2. VM を停止します
3. 停止したら、[設定] の下にある [ネットワーク] に移動します
4. [ネットワーク インターフェイスの接続]
5. [ネットワーク インターフェイスの作成]
6. 名前を付けます (どのような名前でもかまいませんが、必ず覚えておいてください)
7. サブネットのために [Hyper-V-LAN] を選択します
8. ホストが配置されているのと同じリソースグループを選択するようにします
9. [作成]
10. これで前の画面に戻ります。新しく作成されたネットワーク インターフェイスを選択したことを確認し、[OK] を選択します
11. [概要] ペインに戻り、前のアクションが完了したら VM をもう一度起動します
12. 先ほど作成した 2 つ目の NIC に移動します。これは、前に選択したリソース グループ内にあります
13. [IP 構成] に移動し、[IP 転送] を [有効] に切り替えてから変更を保存します

## <a name="setting-up-hyper-v"></a>Hyper-V のセットアップ
1. ホストにリモート接続します
2. 管理者特権の PowerShell プロンプトを開きます
3. 次のコマンドを実行します: `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. これでホストが再起動されます
5. 残りのセットアップを続行するため、ホストに再接続します

## <a name="creating-our-virtual-switch"></a>仮想スイッチの作成

1. 管理者モードで PowerShell を開きます。
2. 内部スイッチを作成します: `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 新しく作成したインターフェイスに IP アドレスを割り当てます: `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>DHCP のインストールと構成

*多くのユーザーが、入れ子になった仮想化を始めて機能させようとしているときに、このコンポーネントを見逃します。ホストが置かれたネットワークからゲスト VM が DHCP を受信するオンプレミスとは異なり、Azure 内で入れ子になっている VM には、それらが実行されているホストを介して DHCP を提供する必要があります。そうしない場合は、入れ子になった VM すべてに IP アドレスを静的に割り当てる必要がありますが、それはスケーラブルではありません。*

1. DHCP の役割をインストールします: `Install-WindowsFeature DHCP -IncludeManagementTools`
2. DHCP スコープを作成します: `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. スコープの DNS とデフォルト ゲートウェイのオプションを構成します: `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 名前解決を機能させる場合は、有効な DNS サーバーを入力するようにします。 この例では [Azure の再帰 DNS](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances) を使用しています。

## <a name="installing-remote-access"></a>リモート アクセスのインストール

1. サーバー マネージャーを開き、[役割と機能の追加] を選択します。
2. [サーバーの役割] が表示されるまで [次へ] を選択します。
3. [リモート アクセス] チェック ボックスをオンにして、[役割サービス] が表示されるまで [次へ] を選択します。
4. [ルーティング] チェック ボックスをオンにして、[機能の追加] を選択し、[次へ]、[インストール] の順に選択します。 ウィザードを完了し、インストールが完了するまで待機します。

## <a name="configuring-remote-access"></a>リモート アクセスの構成

1. サーバー マネージャーを開き、[ツール] を選択し、[ルーティングとリモート アクセス] を選択します。
2. [ルーティングとリモート アクセス] 管理パネルの左側には、その横にサーバー名が示されたアイコンが表示されます。それを右クリックし、[ルーティングとリモート アクセスの構成と有効化] を選択します。
3. ウィザードで [次へ] を選択し、[カスタム構成] を選択して、[次へ] を選択します。
4. [NAT] と [LAN ルーティング] のチェック ボックスをオンにしてから [次へ] を選択し、[完了] を選択します。 サービスを開始するよう指示された場合は、それを実行します。
5. 次に、[IPv4] ノードに移動し、[NAT] ノードが使用可能になるように展開します。
6. [NAT] を右クリックし、[新しいインターフェイス...]、[イーサネット] の順に選択します。これは、IP が "10.0.0.4" である最初の NIC であるはずなので、インターネットに接続するパブリック インターフェイスを選択し、このインターフェイスで NAT を有効にします。 
7. ここで、LAN トラフィックを 2 つ目の NIC に強制的に送信する静的ルートをいくつか作成する必要があります。 これは、[IPv4] の下にある [静的ルート] ノードに移動して実行します。
8. そこへ移動したら、以下のルートを作成します。
    * ルート 1
        * インターフェイス:イーサネット
        * 送信先: 10.0.0.0
        * ネットワーク マスク:255.255.255.0
        * ゲートウェイ:10.0.0.1
        * メトリック:256
        * 注: これをここに配置して、プライマリ NIC が、独自のインターフェイスを出てプライマリ NIC に宛てられたトラフィックに応答できるようにします。 これをここに用意しなかった場合、下記のルートで、NIC 1 宛てであったトラフィックが NIC 2 に送り出されるようになります。 これによって非対称なルートが作成されることになります。 10.0.0.1 は、Azure が NAT サブネットに割り当てる IP アドレスです。 Azure では、範囲内で最初に使用できる IP がデフォルト ゲートウェイとして使用されます。 そのため、NAT サブネットに 192.168.0.0/24 を使用していたとすると、ゲートウェイは 192.168.0.1 になります。 ルーティングでは、より具体的なルートが優先されます。つまり、このルートは次のルートよりも優先されます。

    * ルート 2
        * インターフェイス:イーサネット 2
        * 送信先: 10.0.0.0
        * ネットワーク マスク:255.255.252.0
        * ゲートウェイ:10.0.1.1
        * メトリック:256
        * 注: これは、Azure VNet 宛てのトラフィックのすべてのルートをキャッチするところです。 ここでトラフィックは、2 つ目の NIC に強制的に送り出されます。 入れ子になった VM でアクセスしたい他の範囲については、ルートを追加する必要があります。 そのため、オンプレミス ネットワークが 172.16.0.0/22 の場合、そのトラフィックをハイパーバイザーの 2 つ目の NIC に送信する別のルートを用意する必要があります。

## <a name="creating-a-route-table-within-azure"></a>Azure 内でのルート テーブルの作成

Azure 内でのルートの作成と管理の詳細については、[この記事](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal)を参照してください。

1. https://portal.azure.com に移動します。
2. 左上隅の [リソースの作成] を選択します。
3. 検索フィールドに「ルート テーブル」と入力し、Enter キーを押します。
4. 上位の結果は [ルート テーブル] になるので、これを選択してから [作成] を選択します
5. ルート テーブルに名前を付けます。ここでは "Routes-for-nested-VMs" という名前を付けました。
6. Hyper-V ホストが置かれているのと同じサブスクリプションを選択していることを確認してください。
7. 新しいリソース グループを作成するか、既存のものを選択し、ルート テーブルを作成するリージョンが、Hyper-V ホストが置かれているのと同じリージョンであることを確認します。
8. [作成] を選択します。

## <a name="configuring-the-route-table"></a>ルート テーブルの構成

1. 先ほど作成したルート テーブルに移動します。 ポータルの上部中央にある検索バーからルート テーブルの名前を検索すると、それが可能です。
2. ルート テーブルを選択したら、ブレード内から [ルート] に移動します。
3. [追加] を選択します。
4. ルートに名前を付けます。ここでは "Nested-VMs" と指定しました。
5. アドレス プレフィックスには、"フローティング" サブネットの IP 範囲を入力します。 この場合は 10.0.2.0/24 になります。
6. [次ホップの種類] には [仮想アプライアンス] を選択します。次に、Hyper-V ホストの 2 つ目の NIC の IP アドレス (10.0.1.4 になります) を入力して、[OK] を選択します。
7. ここでブレード内から [サブネット] を選択すると、これは [ルート] のすぐ下になります。
8. [関連付け] を選択し、ここでの [Nested-Fun] という VNet を選択してから、[Azure-VMs] サブネットを選択し、[OK] を選択します。
9. Hyper-V ホストがあるサブネットと、入れ子になった VM にアクセスする必要がある他のすべてのサブネットに対しても、これと同じ手順を実行します。 接続されている場合 

# <a name="end-state-configuration-reference"></a>終了状態の構成に関する参照情報
このガイドの環境は以下の構成となっています。 このセクションは参照情報として使用するためのものです。

1. Azure 仮想ネットワークの情報。
    * VNet 構成の概要。
        * 名前:Nested-Fun
        * アドレス空間:10.0.0.0/22
        * 注: これは 4 つのサブネットで構成されます。 また、これらの範囲は固定的に設定されるものではありません。 お使いの環境に、必要に応じて自由にアドレスを指定できます。 

    * 最初のサブネットの構成の概要。
        * 名前:NAT
        * アドレス空間:10.0.0.0/24
        * 注: これが、プライマリ NIC が置かれている Hyper-V ホストです。 これは、入れ子になった VM 宛ての送信 NAT を処理するために使用されます。 これは入れ子になった VM のための、インターネットへのゲートウェイになります。

    * 2 つ目のサブネットの構成の概要。
        * 名前:Hyper-V-LAN
        * アドレス空間:10.0.1.0/24
        * 注: Hyper-V ホストには、入れ子になった VM と、Hyper-V ホストの外部にある、インターネット以外のリソースとの間のルーティングを処理するために使用される 2つ目の NIC が設けられます。

    * 3 つ目のサブネットの構成の概要。
        * 名前:Ghosted
        * アドレス空間:10.0.2.0/24
        * 注: これは "フローティング" サブネットになります。 アドレス空間は、入れ子になった VM によって使用され、オンプレミスに戻るルートのアドバイスを処理するために存在します。 このサブネットに実際に VM がデプロイされることはありません。

    * 4 つ目のサブネットの構成の概要。
        * 名前:Azure-VMs
        * アドレス空間:10.0.3.0/24
        * 注: Azure VM が含まれるサブネット。

1. Hyper-V ホストの NIC 構成は以下のようになります。
    * プライマリ NIC 
        * IP アドレス:10.0.0.4
        * サブネット マスク:255.255.255.0
        * デフォルト ゲートウェイ:10.0.0.1
        * DNS:DHCP 用に構成される
        * IP 転送の有効化:いいえ

    * セカンダリ NIC
        * IP アドレス:10.0.1.4
        * サブネット マスク:255.255.255.0
        * デフォルト ゲートウェイ:空
        * DNS:DHCP 用に構成される
        * IP 転送の有効化:はい

    * Hyper-V が内部仮想スイッチ用に作成した NIC
        * IP アドレス:10.0.2.1
        * サブネット マスク:255.255.255.0
        * デフォルト ゲートウェイ:空

3. ルート テーブルには 1 つの規則が含まれることになります。
    * 規則 1
        * 名前:Nested-VMs
        * 送信先: 10.0.2.0/24
        * 次ホップ:仮想アプライアンス - 10.0.1.4

## <a name="conclusion"></a>まとめ

これで、仮想マシン (32 ビットの VM を含む) を Hyper-V ホストにデプロイし、オンプレミスから、および Azure 内で、それにアクセスできるようになるはずです。
