---
title: 入れ子になった Vm を構成して、Azure Virtual Network のリソースと直接通信する
description: 入れ子になった仮想化
keywords: windows 10、hyper-v、Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: 2f1c6a124ba4f2f9d199d3cc5bb38c9082f72b3d
ms.sourcegitcommit: a7f9ab96be359afb37783bbff873713770b93758
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/28/2019
ms.locfileid: "9681142"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>入れ子になった Vm を構成して、Azure virtual network のリソースと通信する

Azure 内で入れ子になった仮想マシンを展開して構成するための最初のガイダンスとして、NAT スイッチ経由でこれらの Vm にアクセスする必要があります。 これにはいくつかの制限があります。

1. 入れ子になった Vm は、オンプレミスまたは Azure 仮想ネットワーク内のリソースにアクセスすることはできません。
2. オンプレミスのリソースまたは Azure 内のリソースは、NAT を介して入れ子になった Vm にしかアクセスできません。つまり、複数のゲストが同じポートを共有することはできません。

このドキュメントでは、RRAS、ユーザー定義のルート、ゲストインターネットアクセスを可能にするための送信 NAT 専用のサブネット、および他の仮想マシンと同じように、入れ子になった Vm を動作させて通信できるようにする、"フローティング" アドレス空間を使用した展開について説明します。Azure 内の VNet に直接展開されます。

このガイドを始める前に、次の手順を実行してください。

1. 入れ子になった仮想化について[は、次のガイダンス](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization)を参照してください。
2. 実装前に、この記事をお読みください。

## <a name="high-level-overview-of-what-were-doing-and-why"></a>実行していることと、その理由についての高レベルの概要
* ここでは、2つの Nic を持つネスト対応 VM を作成します。 
* 1つの NIC を使って、NAT を介したインターネットアクセスで入れ子になった Vm を提供したり、その他の NIC を使って、内部のスイッチからハイパーバイザの外部のリソースにトラフィックをルーティングすることができます。 各 NIC は異なるルーティングドメイン内に存在する必要があります。異なるサブネットを意味します。
* これは、少なくとも3つのサブネットを持つ仮想ネットワークが必要であることを意味します。 1つは NAT 用、もう1つは使用されませんが、入れ子になった Vm には "予約" されています。 このドキュメントのサブネットで使用する名前は、"NAT"、"Hyper-v-LAN"、"ゴースト" のうちのどれですか。
* これらのサブネットのサイズは慎重に決定しますが、いくつかの考慮事項があります。 "ゴースト" サブネットのサイズによって、入れ子になった Vm の Ip の数が決まります。 また、"NAT" と "Hyper-v-LAN" のサブネットのサイズによって、ハイパーバイザの Ip の数が決まります。 このため、1つまたは2つのハイパーバイザしか使用していない場合には、厳密には小さなサブネットを作ることができます。
* バックグラウンド: ネストされた Vm は、内部または外部のスイッチを構成している場合でも、ホストが接続されている VNet から DHCP を受信しません。 
  * これは、Hyper-v ホストが DHCP を提供する必要があることを意味します。
* Hyper-v ホストは、現在、VNet で現在割り当てられているリースを認識していないため、ホストが既に存在している IP アドレスを割り当てることができないようにするには、Hyper-v ホストでのみ使用するために IPs のブロックを割り当てる必要があります。 これにより、IP の重複シナリオを回避することができます。
  * 選択する Ip のブロックは、Hyper-v の同じ VNet 内のサブネットに対応しています。
  * これを既存のサブネットに対応させる理由は、ExpressRoute 経由で BGP アドバタイズを戻すことです。 Hyper-v ホスト用の IP 範囲を使用する場合は、一連の静的ルートを作成して、オンプレミスのクライアントが入れ子になった Vm と通信できるようにする必要があります。 これは、入れ子になった Vm の IP 範囲を作成し、クライアントをその範囲の Hyper-v ホストに導くために必要なすべてのルートを作成する場合に、これは困難であるということです。
* ここでは、Hyper-v 内に内部スイッチを作成して、新しく作成されたインターフェイスを、DHCP に対して設定した範囲内で IP アドレスに割り当てます。 この IP アドレスは、入れ子になった Vm のデフォルトゲートウェイとなり、その内部スイッチと VNet に接続されているホストの NIC の間のルーティングに使用されます。
* ホストにルーティングとリモートアクセスの役割をインストールします。これにより、ホストはルーターに変わります。  これは、ホスト外部のリソースと、入れ子になった Vm 間の通信を許可するために必要です。
* このような入れ子になった Vm にアクセスする方法については、他のリソースを参照してください。 このためには、入れ子になった Vm が存在する IP 範囲の静的ルートを含むユーザー定義のルートテーブルを作成することができます。 この静的ルートは、Hyper-v の IP アドレスを指します。
* この UDR をゲートウェイのサブネットに配置すると、オンプレミスのクライアントは、ネストされた Vm への到達方法を知ることができます。
* この UDR は、入れ子になった Vm への接続を必要とする、Azure 内の他のすべてのサブネットにも配置します。
* 複数の Hyper-v ホストの場合は、追加の "フローティング" サブネットを作成し、その他の静的ルートを UDR に追加します。
* Hyper-v ホストの使用を停止する場合は、"フローティング" サブネットを削除または転用して、UDR からその静的ルートを削除します。これが最後の Hyper-v ホストである場合は、UDR をすべて削除します。

## <a name="creating-the-host"></a>ホストの作成

VM 名やリソースグループなど、個人の好みに応じた構成値に対しては、どのような設定値も表示されます。

1. Portal.azure.com に移動する
2. 左上の [リソースの作成] をクリックする
3. 「一般」列から「Window Server 2016 VM」を選択します。
4. [基本] タブで、入れ子になった仮想化が可能な VM サイズを選択します。
5. [ネットワーク] タブに移動する
6. 次の構成で新しい仮想ネットワークを作成する
    * VNet アドレス空間: 10.0.0.0/22
    * サブネット1
        * 名前: NAT
        * アドレススペース: 10.0.0.0/24
    * サブネット2
        * Name: Hyper-v-LAN
        * アドレススペース: 10.0.1.0/24
    * Subnet 3
        * 名前: ゴースト
        * アドレススペース: 10.0.2.0/24
    * サブネット4
        * 名前: Azure-Vm
        * アドレススペース: 10.0.3.0/24
7. VM の NAT サブネットが選択されていることを確認する
8. "校閲と作成" に移動し、[作成] を選択します。

## <a name="create-the-second-network-interface"></a>第2のネットワークインターフェイスを作成する
1. VM のプロビジョニングが完了したら、Azure Portal で参照します。
2. VM を停止する
3. 停止したら、[設定] の [ネットワーク] に移動します。
4. "ネットワークインターフェイスのアタッチ"
5. "ネットワークインターフェイスの作成"
6. 名前を指定します (名前は何でもかまいませんが、覚えておいてください)。
7. サブネットの "Hyper-v-LAN" を選択する
8. ホストが所属しているのと同じリソースグループを選択していることを確認する
9. 作成
10. 前の画面に戻り、新しく作成したネットワークインタフェースを選択して、「OK」を選択します。
11. "概要" ウィンドウに戻り、前の操作が完了したらもう一度 VM を起動します。
12. 作成した2番目の NIC に移動します。これは、以前に選択したリソースグループで見つけることができます。
13. [IP 構成] に移動し、[IP 転送] を [有効] に切り替えて、変更を保存します。

## <a name="setting-up-hyper-v"></a>Hyper-v のセットアップ
1. ホストへのリモート
2. 管理者特権の PowerShell プロンプトを開く
3. 次のコマンドを実行します。 `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. ホストを再起動します
5. 残りのセットアップを続行するには、ホストに再接続してください

## <a name="creating-our-virtual-switch"></a>仮想スイッチの作成

1. 管理モードで PowerShell を開きます。
2. 内部スイッチの作成: `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 新しく作成したインターフェイスに IP を割り当てます。 `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>DHCP をインストールして構成する

*多くのユーザーは、入れ子になった仮想化を初めて使用するときに、このコンポーネントを見逃してしまいます。 オンプレミスとは異なり、ゲストの Vm でホストが存在するネットワークから DHCP を受信する場合とは異なり、Azure の入れ子になった Vm は、それらが実行されているホスト経由で DHCP を提供する必要があります。 または、すべての入れ子になった VM に静的に IP アドレスを割り当てる必要があります。これはスケーラブルではありません。*

1. DHCP の役割をインストールします。 `Install-WindowsFeature DHCP -IncludeManagementTools`
2. DHCP スコープを作成します。 `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. スコープの DNS と既定のゲートウェイオプションを構成します。 `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 名前解決を機能させるには、必ず有効な DNS サーバーを入力してください。 この例では、 [Azure の再帰 DNS](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances)を使用しています。

## <a name="installing-remote-access"></a>リモートアクセスのインストール

1. サーバーマネージャーを開き、[役割と機能の追加] を選択します。
2. "次へ" を選択して "サーバーの役割" を表示します。
3. "リモートアクセス" を確認し、"次へ" をクリックして "役割サービス" を表示します。
4. "ルーティング" を確認し、[機能の追加] を選択して、[次へ]、[インストール] の順に選択します。 ウィザードを完了して、インストールが完了するまで待ちます。

## <a name="configuring-remote-access"></a>リモートアクセスの構成

1. サーバーマネージャーを開き、[ツール]、[ルーティングとリモートアクセス] の順に選択します。
2. [ルーティングとリモートアクセスの管理] パネルの左側に、サーバー名の横にあるアイコンが表示されます。これを右クリックして、[ルーティングとリモートアクセスの構成と有効化] を選びます。
3. ウィザードで、「次へ」を選択し、「設定」のリングボタンをオンにして、「次へ」を選択します。
4. "NAT" と "LAN ルーティング" を確認し、[次へ]、[完了] の順に選択します。 サービスの開始を求められた場合は、次の手順を実行します。
5. 次に、[IPv4] ノードに移動して展開し、"NAT" ノードが利用できるようにします。
6. "NAT" を右クリックし、[新しいインターフェイス...] を選択します。「イーサネット」を選択します。これは、「10.0.0.4」の IP の最初の NIC である必要があります。
7. 次に、2つ目の NIC からの LAN トラフィックを強制する静的ルートをいくつか作成する必要があります。 これを行うには、"IPv4" の下にある "静的ルート" ノードに移動します。
8. 次のルートを作成します。
    * ルート1
        * インターフェイス: イーサネット
        * Destination: 10.0.0.0
        * ネットワークマスク: 255.255.255.0
        * ゲートウェイ: 10.0.0.1
        * メトリック: 256
        * 注: このページでは、プライマリ NIC が独自のインターフェイスから送信されるトラフィックに応答できるようにします。 この手順を実行していない場合は、NIC 1 のトラフィックが NIC 2 に転送されることになります。 これにより、非対称ルートが作成されます。 10.0.0.1 は、Azure が NAT サブネットに割り当てる IP アドレスです。 Azure は、範囲内で最初に使用できる IP を既定のゲートウェイとして使用します。 したがって、NAT サブネットで 192.168.0.0/24 を使ったことがある場合は、ゲートウェイは192.168.0.1 になります。 [より具体的なルートをルーティングする] では、このルートが以下のルートより優先されることを意味します。

    * ルート2
        * インターフェイス: イーサネット2
        * Destination: 10.0.0.0
        * ネットワークマスク: 255.255.252.0
        * ゲートウェイ: 10.0.1.1
        * メトリック: 256
        * 注: これは、Azure VNet を対象としたトラフィックのキャッチすべてのルートです。 第2の NIC は強制的にトラフィックを送信します。 他の範囲に対して、入れ子になった Vm にアクセスするためのルートを追加する必要があります。 オンプレミスネットワークの場合は 172.16.0.0/22 の場合、ハイパーバイザの第2の NIC からトラフィックを送信するために、別のルートを追加する必要があります。

## <a name="creating-a-route-table-within-azure"></a>Azure 内でルートテーブルを作成する

詳細については、 [「](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal) Azure 内でルートを作成および管理する」を参照してください。

1. にhttps://portal.azure.com移動します。
2. 左上隅にある [リソースの作成] を選びます。
3. 検索フィールドに「Route Table」と入力して、enter キーを押します。
4. 最上位の結果は [Route] テーブルになります。これを選択し、[作成] を選択します。
5. ルートテーブルに名前を付けます。自分の名前は、"ルートの下位の Vm" という名前にします。
6. Hyper-v ホストが保存されているのと同じサブスクリプションを選択していることを確認してください。
7. 新しいリソースグループを作成するか、既存のものを選択して、ルートテーブルを作成する地域が、Hyper-v ホストが存在する地域と同じであることを確認します。
8. [作成] を選びます。

## <a name="configuring-the-route-table"></a>ルートテーブルの構成

1. 先ほど作成したルートテーブルに移動します。 この操作を行うには、ポータルの上部の中央にある検索バーからルートテーブルの名前を検索します。
2. ルートテーブルを選択したら、ブレード内から「ルート」に移動します。
3. [追加] を選びます。
4. ルートに名前を付け、"ネストされた Vm" という名前を付けます。
5. アドレスプレフィックスには、"フローティング" サブネットの IP 範囲を入力します。 この場合は、10.0.2.0/24 となります。
6. 「次のホップの種類」では、「仮想アプライアンス」を選択してから、Hyper-v ホストの第2の NIC の IP アドレスを入力して、「OK」を選択します。
7. ブレード内から「サブネット」を選択します。これは「ルート」のすぐ下に表示されます。
8. [関連付け] を選び、"ネストされた楽しい" VNet を選んでから、"Azure Vm" サブネットを選び、[OK] を選びます。
9. この手順は、Hyper-v ホストが配置されているサブネットと、入れ子になった Vm にアクセスする必要があるその他のサブネットについても行います。 接続されている場合 

# <a name="end-state-configuration-reference"></a>終了状態の構成リファレンス
このガイドの環境には、以下の構成があります。 このセクションでは、参照として使用するための方法について説明します。

1. Azure 仮想ネットワークの情報。
    * VNet 高レベル構成。
        * 名前: ネスト-楽しい
        * アドレススペース: 10.0.0.0/22
        * 注: これは、4つのサブネットで構成されます。 また、これらの範囲は [石] に設定されません。 必要に応じて、お客様の環境を無料でお使いいただけます。 

    * 第1のサブネットの高レベル構成。
        * 名前: NAT
        * アドレススペース: 10.0.0.0/24
        * 注: ここでは、Hyper-v ホストプライマリ NIC が保存されています。 これは、入れ子になった Vm の送信 NAT を処理するために使用されます。 これは、ネストされた Vm のインターネットへのゲートウェイになります。

    * 第2のサブネットの高レベル構成。
        * Name: Hyper-v-LAN
        * アドレススペース: 10.0.1.0/24
        * 注: Hyper-v ホストには、入れ子になった Vm と、Hyper-v ホストの外部のインターネット以外のリソース間のルーティングを処理するために使用される2つ目の NIC があります。

    * 第3のサブネットの高レベル構成。
        * 名前: ゴースト
        * アドレススペース: 10.0.2.0/24
        * 注: これは "フローティング" サブネットになります。 アドレス空間は、入れ子になった Vm によって消費され、オンプレミスに戻すためのアドバタイズを処理するために存在します。 実際には、このサブネットには Vm は展開されません。

    * 第4サブネットの高レベル構成。
        * 名前: Azure-Vm
        * アドレススペース: 10.0.3.0/24
        * 注: Azure Vm を含むサブネット。

1. Hyper-v のホストには、以下の NIC 構成があります。
    * プライマリ NIC 
        * IP Address: 10.0.0.4
        * サブネットマスク: 255.255.255.0
        * 既定のゲートウェイ: 10.0.0.1
        * DNS: DHCP 用に構成されています
        * IP 転送が有効: いいえ

    * セカンダリ NIC
        * IP Address: 10.0.1.4
        * サブネットマスク: 255.255.255.0
        * 既定のゲートウェイ: 空
        * DNS: DHCP 用に構成されています
        * [IP 転送有効]: はい

    * Hyper-v が内部仮想スイッチ用に NIC を作成しました
        * IP Address: 10.0.2.1
        * サブネットマスク: 255.255.255.0
        * 既定のゲートウェイ: 空

3. ルートテーブルには1つのルールがあります。
    * ルール1
        * 名前: 入れ子になった Vm
        * Destination: 10.0.2.0/24
        * 次ホップ: 仮想アプライアンス-10.0.1.4

## <a name="conclusion"></a>まとめ

これで、Hyper-v ホストに仮想マシン (32 ビット VM) を展開できるようになり、オンプレミスと Azure の間でアクセスできるようになります。
