---
title: Azure 仮想ネットワークでのリソースを直接やり取り入れ子になった仮想マシンの構成
description: 入れ子になった仮想化
keywords: windows 10、ハイパー v Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: 18ab4d1d87c22f70fe09aae5222a7d125ac9c974
ms.sourcegitcommit: 914e0dd1168daf1d2b0f22bd011035016cc08baf
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/23/2019
ms.locfileid: "9099390"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>Azure 仮想ネットワークでのリソースとの通信に入れ子になった仮想マシンを構成します。

元の展開と Azure で入れ子になったの仮想マシンの構成に関するガイダンス NAT スイッチでこれらの仮想マシンにアクセスすることが必要です。 これには、いくつかの制限が表示されます。

1. 入れ子になった仮想マシンのリソース オンプレミスにアクセスできない、または Azure 仮想ネットワーク内でします。
2. 内部設置型リソースまたは Azure 内のリソースによってのみアクセスできます入れ子になったの仮想マシン、NAT では、同じポートを共有できないのは、複数のゲストを意味します。

このドキュメントはあなたの動作し、その他の任意の仮想マシンのようなコミュニケーションを仮想マシンの入れ子になったを RRAS、ユーザー定義のルートでは、専用ゲスト インターネットへのアクセスと「浮動」アドレス空間を許可する送信 NAT サブネットの使用も行う展開想定します。直接、VNet Azure 内に配置されます。

前に、このガイドを起動してください。

1. [ガイダンスがここに示す](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/nested-virtualization)仮想化の入れ子になったことをお読みください。
2. この記事で全体の実装よりも前。

## <a name="high-level-overview-of-what-were-doing-and-why"></a>何の高度な概要とその理由
* 2 つの nic ネスト機能を持つ VM を作成します。 
* いずれかの NIC を使用して、入れ子になった仮想マシン NAT およびその他の NIC でインターネットへのアクセスを提供ハイパーバイザに、スイッチの内部から外部リソースへのトラフィックをルーティングする使用されます。 各 NIC は、別のサブネットの意味を別のルーティング ドメインにする必要があります。
* これは、最低限の 3 つのサブネットでの仮想ネットワークが必要なことを意味します。 NAT のいずれかの LAN ルーティングのいずれか、いずれかは使用されませんが、入れ子になった仮想マシンの「予約」します。 この文書でサブネットの使用は名前は、"NAT"、"ハイパー-V-LAN"、および"Ghosted"します。
* これらのサブネットのサイズは自由にですが、いくつかの注意事項があります。 "Ghosted"サブネットのサイズ指定数の ip アドレス、入れ子になった仮想マシンがあります。 "NAT"と"ハイパー V LAN"サブネットのサイズが ip アドレスの数を決定するも、ハイパーバイザーがあります。 ようにする可能性のある技術的に不可能です小規模サブネットは、ここに 1 つまたは 2 つのハイパーバイザーのみを計画していた場合。
* 背景: 入れ子になった仮想マシンは届きません DHCP 内部または外部スイッチを構成する場合でも、ホストに接続されている VNet から。 
  * これは、場合、HYPER-V ホストが DHCP を提供する必要があります。
* HYPER-V ホストは、VNet に現在割り当てられているリースの注意をホスト割り当てます IP 既に存在する状況を回避するために HYPER-V ホストをだけで、使用するための ip アドレスのブロックを割り当てるは必要があります。 これにより、重複する IP シナリオを回避することができます。
  * 選択の ip アドレスのブロック内での HYPER-V は同じ VNet サブネットが対応しています。
  * 既存のサブネットに対応するようにし理由は、ExpressRoute を介して BGP 通知を処理します。 使用する HYPER-V ホストの IP 範囲をだけに適用されたはかどうかは、一連のクライアントを許可する静的ルートを作成する必要があるオンプレミス入れ子になったの仮想マシンで通信します。 これはないハード要件入れ子になったの仮想マシンの IP 範囲を構成するし、クライアントの HYPER-V ホストが必要なすべてのルートを作成し、可能性のあるわけではします。
* HYPER-V 内の内部のスイッチを作成し、し、割り当てることで、新しく作成されたインターフェイス DHCP を確保し、設定の範囲に含まれる IP アドレス。 次の IP アドレスは、入れ子になった仮想マシンの既定のゲートウェイとなるし、する内部スイッチと VNet 当社に接続されているホストの NIC の間にルーティングするために使用します。
* ホストで、ホストをルーターに変わりますルーティングとリモート アクセスの役割をインストールします。  これは、機能は、リソースのホストに外部と、入れ子になった仮想マシンの間の通信を許可する必要があります。
* その他のリソースは、これらの入れ子になった仮想マシンへのアクセス方法お知らせします。 これにより、入れ子になったの仮想マシンの内に存在する IP 範囲の静的ルートを含むユーザー定義のルーティング テーブルを作成することが必要です。 この静的ルートが hyper-v が、IP アドレスをポイントします。
* オンプレミスに由来クライアントは、入れ子になった仮想マシンに到達する方法を理解できるように、ゲートウェイ サブネットにこの UDR を配置するされます。
* その他のサブネット内に入れ子になったの仮想マシンへの接続が必要な Azure でこの UDR を配置することもされます。
* 複数の HYPER-V ホストの追加の「浮動」サブネットを作成し、UDR にその他の静的ルートを追加します。
* HYPER-V ホストの使用を停止するときに、削除/転用当社「浮動」サブネットとから UDR 当社は、その静的ルートを削除するかの場合は、最後の HYPER-V ホスト完全に削除する、UDR します。

## <a name="creating-the-host"></a>ホストを作成します。

VM 名、[リソース グループ] などの個人設定には、任意の構成の値は光沢は…

1. Portal.azure.com に移動します。
2. 左上の「リソースを作成する」をクリックします。
3. 人気のある列から「ウィンドウ サーバーの 2016 の仮想マシン」を選択します。
4. 「基本」] タブであることができる入れ子になった仮想化の仮想メモリのサイズを選択してください。
5. "ネットワーク] タブに移動します。
6. 次の構成で新しい仮想ネットワークを作成します。
    * VNet アドレス空間: 10.0.0.0/22
    * サブネット 1
        * 名前: NAT
        * アドレス スペース: 10.0.0.0/24
    * サブネット 2
        * [Name]: ハイパー V-LAN
        * アドレス スペース: 10.0.1.0/24
    * サブネット 3
        * 名前: 半透明
        * アドレス スペース: 10.0.2.0/24
    * サブネット 4
        * [Name]: Azure の仮想マシン
        * アドレス スペース: 10.0.3.0/24
7. VM の NAT サブネットを選んだことを確認します。
8. 移動"校閲作成 +"と「作成」を選択

## <a name="create-the-second-network-interface"></a>2 番目のネットワーク インターフェイスを作成します。
1. VM 後が完了したら、Azure ポータル内で参照のプロビジョニング
2. VM を停止します。
3. [設定] では、「ネットワーク」に 1 回停止の移動
4. 「ネットワーク インターフェイスを添付する」
5. 「ネットワーク インターフェイスを作成する」
6. 名前を付ける (しない名前、問題はことを覚えておいてください)
7. サブネットの"ハイパー V LAN"を選択します。
8. グループを選び、同じリソースで、ホストが格納されていることを確認します。
9. 「作成」
10. これは前の画面にリンクする場合、新しく作成されたネットワーク インターフェイスを選択し、"OK"を選択することを確認
11. 「概要」ウィンドウに戻るし、直前の操作が完了したら、仮想マシンをもう一度開始
12. 移動を作成した 2 つ目の NIC、見つけられるで [リソース グループ] が選択されていた
13. 「IP 転送」を「有効」に切り替えるし、変更を保存し、"IP 構成] に移動

## <a name="setting-up-hyper-v"></a>HYPER-V を設定
1. ホストにリモート
2. 管理者特権の PowerShell のプロンプトを開く
3. 次のコマンドを実行します。 `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. これがホストを再起動します。
5. セットアップの残りの部分を続けるには、ホストに接続し直す

## <a name="creating-our-virtual-switch"></a>仮想、スイッチを作成します。

1. PowerShell を管理モードで開きます。
2. 内部スイッチを作成します。 `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 新しく作成されたインターフェイス IP を割り当てます。 `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>インストールおよび DHCP を構成します。

*多数のユーザーは、まずしようとしている入れ子になった仮想化の作業を開始するときにこのコンポーネントを見逃します。 異なり社内で、ゲスト仮想マシンのネットワークに存在し、ホストから DHCP を受信できる場所で Azure 仮想マシンを入れ子になったする必要があります DHCP を通じて提供ホスト上で実行します。 か、静的 IP アドレスに割り当てる、ネストされた各仮想マシン スケーラブルではない必要があります。*

1. DHCP の役割をインストールします。 `Install-WindowsFeature DHCP -IncludeManagementTools`
2. DHCP スコープを作成します。 `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. スコープの DNS とゲートウェイの既定のオプションを構成するには。 `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 名前を解決する場合は、有効な DNS サーバーを入力することを確認します。 ここでは[Azure の再帰 DNS](https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances)を使っています。

## <a name="installing-remote-access"></a>リモート アクセスをインストールします。

1. サーバー マネージャーを開き、"役割の追加と機能] を選択します。
2. "サーバーの役割] に移動するまでは、[次へ] を選択します。
3. 「リモート アクセス」を確認し、"役割サービス] に移動するまでは、[「次へ」をクリックします。
4. 「ルーティング」を確認、機能の追加""を選択し、"次へ] と [インストール] を選択します。 ウィザードを完了して、インストールが完了するを待ちます。

## <a name="configuring-remote-access"></a>リモート アクセスを構成します。

1. サーバー マネージャーを開く、「ツール」を選択し、「ルーティングとリモート アクセス」を選択します。
2. ルーティングとリモート アクセス管理パネルの右側にあるアイコンがその横にあるサーバー名を表示、これを右クリックして「を構成して有効にするルーティングとリモート アクセス」を選択します。
3. ウィザードの次へ] を選択、および「ユーザー設定の構成」リング ボタンをオンに"次へ] を選択します。
4. "NAT"チェック"LAN"とし、["次へ] と [「完了」します。 場合は、サービスを開始し、[実行することが表示されます。
5. 今すぐ"IPv4"ノードに移動し、展開"NAT"ノードを利用できるようにします。
6. "NAT"を右クリックして、「新しいインターフェイス...」を選択します。「イーサネット」を選択し、最初の NIC「10.0.0.4」の ip アドレスがあります
7. 今すぐ強制的に 2 つ目の NIC の LAN トラフィックのいくつかの静的なルートを作成する必要があります。 この操作には、「静的ルート」の"IPv4"下に移動します。
8. いったんが以下のルートを作成します。
    * ルーティング 1
        * インターフェイス: イーサネット
        * 宛先: 10.0.0.0
        * ネットワークのマスク: 255.255.255.0
        * ゲートウェイ: 10.0.0.1
        * メートル法: 256
        * メモ: みましたこれは、ここにプライマリ NIC に応答する独自のインターフェイスにトラフィックを許可します。 これは、ここがなかった次のようなルートなるトラフィック NIC の 1 NIC 2 を移動するためのものになります。 これにより、非対称ルーティングを作成します。 10.0.0.1 は、Azure が NAT サブネットに割り当てられた IP アドレスです。 Azure では、既定のゲートウェイとして、範囲内で最初の使用できる ip アドレスを使用します。 ように NAT サブネットの 192.168.0.0/24 を使用する場合は、ゲートウェイが 192.168.0.1 になります。 Wins、つまり、この設定はより優先ルーティング、特定のルートで、下にあるルーティングします。

    * ルート 2
        * インターフェイス: イーサネット 2
        * 宛先: 10.0.0.0
        * ネットワークのマスク: 255.255.252.0
        * ゲートウェイ: 10.0.1.1
        * メートル法: 256
        * メモ: これは、すべてを Azure VNet にトラフィックをルーティング問題です。 強制的にトラフィックを 2 番目の NIC その他のルート、入れ子になったの仮想マシンにアクセスするその他の範囲を追加する必要があります。 場合は、オンプレミス ネットワークが 172.16.0.0/22 し、そのハイパーバイザ当社の 2 番目の NIC のトラフィックを送信する別の経路を使用するとします。

## <a name="creating-a-route-table-within-azure"></a>Azure 内のルーティング テーブルを作成します。

奥行きの作成と管理 Azure 内の経路を読むよりは、[この記事](https://docs.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal)を参照してください。

1. 移動するhttps://portal.azure.comします。
2. 左上隅で、「リソースを作成する」を選択します。
3. 検索フィールドで、「ルート テーブル」を入力し、ヒットを入力します。
4. 上の結果がルート テーブルには、このオプションを選択し、[「作成」
5. ルーティング テーブルの名前を今回はという「ルート-用の入れ子になった-仮想マシン」します。
6. 同じサブスクリプションに存在する、HYPER-V ホストを選択することを確認します。
7. 新しい設備グループを作成するか、または既存のものを選択しのルート テーブルを作成する領域が含まれる、HYPER-V ホスト同じ領域であることを確認します。
8. 「作成」を選択します。

## <a name="configuring-the-route-table"></a>ルート テーブルを構成します。

1. 作成したルート テーブルに移動します。 ポータルの上部にある検索バーからルート テーブルの名前を検索して、これを行うことができます。
2. 選択した後にルーティング テーブルからの「ルート」にブレード内で移動します。
3. "の追加] を選択します。
4. ルートに名前を付けて、「入れ子になった仮想マシンの」とはしました。
5. アドレスに接頭辞は、「フリー」サブネットの IP 範囲を入力します。 ここでは 10.0.2.0/24 でしょう。
6. 「仮想アプライアンス」を選択し、ip アドレスを入力「次ホップ型」の HYPER-V のアドレスが 10.0.1.4、すると"OK"を選択し、NIC をホストします。
7. 今すぐブレード select「サブネット」内でこれは、「ルート」の下にあります。
8. 「関連付け」を選択し、「入れ子になった楽しい」VNet を選択「Azure 仮想マシンの」サブネットを選択して"OK"を選択します。
9. 上にある HYPER-V ホストも入れ子になったの仮想マシンにアクセスする必要があるその他の任意のサブネットとサブネットの同じ手順を実行します。 接続されている場合 

# <a name="end-state-configuration-reference"></a>終了状態の構成のリファレンス
このガイドの環境には、[構成の下にあります。 ここでは、参照として使用する inteded です。

1. Azure 仮想ネットワーク情報。
    * VNet 高レベルの構成します。
        * [Name]: 入れ子になった楽しい
        * アドレス スペース: 10.0.0.0/22
        * メモ: これは、構成の 4 つのサブネットします。 また、これらの範囲では、石に設定されていません。 必要に応じて、その使用環境に対処する自由にします。 

    * 最初のサブネット高レベルの構成します。
        * 名前: NAT
        * アドレス スペース: 10.0.0.0/24
        * メモ: これは、HYPER-V がプライマリ NIC をホストが格納されています。 入れ子になったの仮想マシンの送信 NAT を処理するために使用されます。 インターネット、入れ子になった仮想マシンでのゲートウェイがあります。

    * 2 番目のサブネット高レベルの構成します。
        * [Name]: ハイパー V-LAN
        * アドレス スペース: 10.0.1.0/24
        * メモ: HYPER-V ホスト仮想マシンの入れ子になったとインターネットではないリソース HYPER-V ホストの外部の間のルーティングを処理に使用される 2 つ目の NIC が割り当てられます。

    * 3 番目のサブネット高レベルの構成します。
        * 名前: 半透明
        * アドレス スペース: 10.0.2.0/24
        * メモ:「浮動」サブネットになります。 アドレス空間は、入れ子になった仮想マシンで使用され、オンプレミスへルーティング広告の処理が既に存在します。 仮想マシン実際に展開しないこのサブネットします。

    * 4 番目サブネット高レベルの構成します。
        * [Name]: Azure の仮想マシン
        * アドレス スペース: 10.0.3.0/24
        * メモ: サブネットが Azure 仮想マシンが含まれています。

1. HYPER-V ホストが、NIC の構成の下にあります。
    * プライマリ NIC 
        * IP アドレス: 10.0.0.4
        * サブネット マスク: 255.255.255.0
        * 既定のゲートウェイ: 10.0.0.1
        * DNS: DHCP 用に構成
        * IP 転送が有効になっている: なし

    * 第 2 NIC
        * IP アドレス: 10.0.1.4
        * サブネット マスク: 255.255.255.0
        * 既定のゲートウェイ: 空
        * DNS: DHCP 用に構成
        * IP 転送が有効になっている: はい

    * Hyper-v 仮想スイッチの内部に NIC を作成します。
        * IP アドレス: 10.0.2.1
        * サブネット マスク: 255.255.255.0
        * 既定のゲートウェイ: 空

3. ルーティング テーブル 1 つのルールが表示されます。
    * ルール 1
        * [Name]: - 仮想マシン入れ子になった
        * 宛先: 10.0.2.0/24
        * 次のホップ: 仮想アプライアンス - 10.0.1.4

## <a name="conclusion"></a>まとめ

HYPER-V ホストを仮想マシン (32 ビット VM も!) を展開するには、内部設置型からと Azure 内でアクセス可能なを今すぐはずです。
