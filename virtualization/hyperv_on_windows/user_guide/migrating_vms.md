# 仮想マシンの移行とアップグレード

Windows 8.1 以前で Hyper-V を使用して作成した仮想マシンを Windows 10 ホストに移行する場合、仮想マシン構成バージョンを手動で更新するまで、新しい仮想マシンの機能は使用できません。

構成バージョンをアップグレードするには、仮想マシンをシャットダウンし、Hyper-V マネージャーで [仮想マシン構成のアップグレード] を選択します。 また、管理者特権で Windows PowerShell コマンド プロンプトを開き、次のように入力することもできます。

 ```PowerShell
Update-VmVersion <vmname> | <vmobject>
 ```

## Hyper-V で実行されている仮想マシンの構成バージョンを確認するにはどうすればよいですか。

構成バージョンを確認するには、管理者特権で Windows PowerShell コマンド プロンプトを開き、次のコマンドを実行します。

**Get-VM * | Format-Table Name, Version**

この PowerShell コマンドで、次の出力例が生成されます。

```
Name        State       CPUUsage(%) MemoryAssigned(M)   Uptime              Status                  Version

Atlantis    Running         0       1024                00:04:20.5910000    Operating normally      5.0

SGC VM      Running         0       538                 00:02:44.8350000    Operating normally      6.2
```


## 構成バージョンをアップグレードしないとどうなりますか。

旧バージョンの Hyper-V で作成した仮想マシンがある場合、VM バージョンを更新するまで、仮想マシンで使用できない機能が生じる可能性があります。

新しい Hyper-V 機能の最低限の VM 構成バージョン:

| **機能名**| **最低限の VM バージョン**| |
| :------------------------------------- | -----------------: ||
| ホット アド/リムーブ メモリ| 6.0| |
| ホット アド/リムーブ ネットワーク アダプター| 5.0| |
| Linux VM のセキュア ブート| 6.0| |
| 運用チェックポイント| 6.0| |
| PowerShell ダイレクト| 6.2| |
| 仮想トラステッド プラットフォーム モジュール (vTPM)| 6.2| |
| 仮想マシンのグループ化| 6.2| |



## 仮想マシン構成バージョン

Windows 8.1 を実行するホストから Windows 10 で Hyper-V を実行するホストに仮想マシンを移動またはインポートするとき、仮想マシンの構成ファイルは自動的にアップグレードされません。 このため、Windows 8.1 を実行するホストに仮想マシンを戻すことができます。 仮想マシンの構成バージョンを手動で更新するまで、新しい仮想マシンの機能にアクセスすることはできません。

仮想マシンの構成バージョンは、仮想マシンの構成、保存された状態、スナップショット ファイルとの間で互換性がある Hyper-V のバージョンを示しています。 構成バージョン 5 の仮想マシンは Windows 8.1 との間に互換性があり、Windows 8.1 と Windows 10 の両方で実行できます。 構成バージョン 6 の仮想マシンは Windows 10 との間に互換性があり、Windows 8.1 では実行できません。

すべての仮想マシンを同時にアップグレードする必要はありません。 必要に応じて、特定の仮想マシンをアップグレードすることもできます。 ただし、各仮想マシンの仮想マシンの構成バージョンを手動で更新するまで、新しい仮想マシンの機能にアクセスすることはできません。


----------------

**重要**

• 仮想マシンの構成バージョンをアップグレードした後、Windows 8.1 を実行するホストに仮想マシンを移動することはできません。

• バージョン 6 からバージョン 5 に仮想マシンの構成バージョンをダウングレードすることはできません。

• 仮想マシンの構成をアップグレードするには、仮想マシンをオフにする必要があります。

• アップグレード後、仮想マシンは新しい構成ファイル形式を使用します。 詳細については、「新しい仮想マシン構成ファイル形式」を参照してください。

--------






## 仮想マシンのバージョンをアップグレードしないとどうなりますか。

仮想マシンの構成バージョンを手動でバージョン 6.x にアップグレードすると、仮想マシン構成とチェックポイント ファイルの格納に使用されているファイル構造が変わります。

アップグレードされた仮想マシンは、新しい構成ファイル形式を使用します。新しいバージョンは、仮想マシン構成データを読み書きするときの効率を上げるように設計されています。 アップグレードすると、記憶域で障害が発生した場合のデータ破損の確率も低くなります。

次の表は、アップグレードした仮想マシンのバイナリ ファイルの場所と拡張子に関する情報の一覧です。

| **仮想マシンの構成とチェックポイント ファイル (バージョン 6.x)**| **説明**| |
|:---------------|:----------------||
| **仮想マシンの構成**| 構成情報は、拡張子が .vmcx のバイナリ ファイル形式に格納されます。| |
| **仮想マシンのランタイム状態**| ランタイム状態データは、拡張子が .vmrs のバイナリ ファイル形式に格納されます。| |
| **仮想マシンの仮想ハード ディスク**| 仮想マシンの仮想ハード ディスク。ファイル拡張子は .vhd または .vhdx です。| |
| **自動仮想ハード ディスク ファイル**| 仮想マシン チェックポイントに使用される差分ディスク ファイル。ファイル拡張子は .avhdx です。| |
| **チェックポイント ファイル**| チェックポイントは、複数のチェックポイント ファイルに格納されます。各チェックポイントで、構成ファイルとランタイム状態ファイルが作成されます。チェックポイント ファイルの拡張子は .vmrs と .vmcx です。これらの新しいファイル形式は、運用チェックポイントと標準のチェックポイントにも使用されます。| |

仮想マシン構成バージョンをバージョン 6.x にアップグレードした後に、バージョン 6.x をバージョン 5 にダウングレードすることはできません。

仮想マシン構成をアップグレードするには、仮想マシンをオフにする必要があります。

次の表は、新規またはアップグレードした仮想マシンの既定のファイルの場所一覧です。

| **仮想マシンファイル (バージョン 6.x)**| **説明**| |
|:-----|:-----||
| **仮想マシンの構成ファイル**| C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual Machines| |
| **仮想マシンのランタイム状態ファイル**| C:\ProgramData\Microsoft\Windows\Hyper-V\Virtual Machines| |
| **チェックポイント ファイル (.vmrs、.vmcx)**| C:\ProgramData\Microsoft\Windows\Snapshots| |
| **仮想ハード ディスク ファイル (.vhd/.vhdx)**| C:\Users\Public\Documents\Hyper-V\Virtual Hard Disks| |
| **自動仮想ハード ディスク ファイル (.avhdx)**| C:\Users\Public\Documents\Hyper-V\Virtual Hard Disks| |








