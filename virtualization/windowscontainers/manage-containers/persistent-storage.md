---
title: コンテナー内の永続的なストレージ
description: Windows コンテナーでストレージを永続化する方法
keywords: コンテナー, ボリューム, 記憶域, マウント, bindmount
author: cwilhit
ms.openlocfilehash: 945a78d4ecb9c96da4de8f7246f84b6b444dd5b5
ms.sourcegitcommit: 1ca9d7562a877c47f227f1a8e6583cb024909749
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/04/2019
ms.locfileid: "74909672"
---
# <a name="persistent-storage-in-containers"></a>コンテナー内の永続的なストレージ

<!-- Great diagram would be great! -->

場合によっては、アプリがコンテナー内のデータを永続化できること、またはコンテナーのビルド時に含まれていないコンテナーにファイルを表示することが重要な場合があります。 永続ストレージは、次の2つの方法でコンテナーに割り当てることができます。

- バインド マウント
- 名前付きボリューム

Docker には、[ボリュームの使用](https://docs.docker.com/engine/admin/volumes/volumes/)に関する概要が用意されているため、まずそのドキュメントをご覧ください。 このページの残りの部分では、Linux と Windows の違いについて説明し、Windows の場合の例を示します。

## <a name="bind-mounts"></a>バインド マウント

[バインド マウント](https://docs.docker.com/engine/admin/volumes/bind-mounts/)を使用すると、コンテナーがディレクトリをホストと共有できます。 この方法は、コンテナーを再起動したときに使用可能なローカル コンピューター上のファイルを保存する場所が必要な場合や、複数のコンテナーと共有する場合に有効です。 コンテナーを複数のコンピューターで実行して同じファイルにアクセスする場合は、代わりに名前付きボリュームまたは SMB マウントを使用する必要があります。

### <a name="permissions"></a>アクセス許可

バインド マウントに使用されるアクセス許可モデルは、コンテナーの分離レベルによって異なります。

**Hyper-v 分離**を使用するコンテナーは、単純な読み取り専用または読み取り/書き込みアクセス許可モデルを使用します。 ホスト上のファイル アクセスには `LocalSystem` アカウントを使用します。 コンテナーに対するアクセスが拒否される場合は、ホスト上のそのディレクトリに `LocalSystem` からのアクセス許可があることを確認してください。 読み取り専用フラグが使用された場合、コンテナー内のボリュームへの変更はホスト上のディレクトリに永続化または表示されません。

**プロセス分離**を使用した Windows コンテナーは、コンテナー内のプロセス id を使用してデータにアクセスするため、若干異なります。つまり、ファイル acl が受け入れられます。 マウントされたボリューム内のファイルとディレクトリへのアクセスには、`LocalSystem` ではなく、コンテナーで実行されているプロセスの ID (既定で Windows サーバー コアの場合は "ContainerAdministrator"、Nano Server コンテナーの場合は "ContainerUser") が使用され、データを使用するにはアクセス権が必要になります。

これらの id はコンテナーのコンテキスト内にのみ存在するため、ファイルが格納されているホスト上には存在しません。そのため、Acl を構成してコンテナーへのアクセスを許可する場合は、`Authenticated Users` などのよく知られたセキュリティグループを使用する必要があります。

> [!WARNING]
> `C:\` などの機密性の高いディレクトリは、信頼されていないコンテナーにバインド マウントしないでください。 このようなバインド マウントを行うと、通常はアクセスできないホスト上のファイルへの変更が許可され、セキュリティ侵害が生じる可能性があります。

使用例:

- 読み取り専用アクセスの `docker run -v c:\ContainerData:c:\data:RO`
- 読み取り/書き込みアクセスの `docker run -v c:\ContainerData:c:\data:RW`
- 読み取り/書き込みアクセスの `docker run -v c:\ContainerData:c:\data` (既定)

### <a name="symlinks"></a>symlink

symlink は、コンテナ内で解決されます。 symlink であるコンテナーまたは symlink を含むコンテナーにホスト パスをバインド マウントしても、コンテナーではこれらの symlink にアクセスできません。

### <a name="smb-mounts"></a>SMB マウント

Windows Server バージョン1709以降では、"SMB グローバルマッピング" と呼ばれる機能を使用して、ホストに SMB 共有をマウントし、その共有上のディレクトリをコンテナーに渡すことができます。 コンテナーは、特定のサーバー、共有、ユーザー名、またはパスワードを指定して構成する必要はありません。これはすべてホストで処理されます。 コンテナーは、ローカル記憶域がある場合と同様に機能します。

#### <a name="configuration-steps"></a>構成手順

1. コンテナーホストで、リモート SMB 共有をグローバルにマップします。
    ```
    $creds = Get-Credential
    New-SmbGlobalMapping -RemotePath \\contosofileserver\share1 -Credential $creds -LocalPath G:
    ```
    このコマンドは、資格情報を使用してリモート SMB サーバーで認証を行います。 次に、リモート共有パスを G: ドライブ文字にマップします (その他の使用可能なドライブ文字も指定できます)。 このコンテナー ホストで作成されたコンテナーでは、自身のデータ ボリュームを G: ドライブ上のパスにマップできます。

    > [!NOTE]
    > コンテナーに対して SMB グローバルマッピングを使用する場合、コンテナーホスト上のすべてのユーザーがリモート共有にアクセスできます。 コンテナー ホストで実行されているすべてのアプリケーションにも、マッピングされたリモート共有へのアクセス権があります。

2. グローバルにマウントされた SMB 共有んいマップされたデータ ボリュームを使用してコンテナーを作成します: docker run -it --name demo -v g:\ContainerData:G:\AppData1 microsoft/windowsservercore:1709 cmd.exe

    コンテナー内で、G:\AppData1 はリモート共有の "ContainerData" ディレクトリにマップされます。 グローバルにマップされたリモート共有に格納されているデータは、コンテナー内のアプリケーションで使用できるようになります。 複数のコンテナーが同じコマンドを使用して、この共有データへの読み取り/書き込みアクセス権を獲得することもできます。

この SMB グローバル マッピングは、互換性のある SMB サーバー上で動作できる SMB クライアント側の機能によってサポートされます。次のようなものがあります。

- 記憶域スペース ダイレクト (S2D) 上のスケール アウト ファイル サーバーまたは従来の SAN
- Azure Files (SMB 共有)
- 従来のファイル サーバー
- SMB プロトコルのサード パーティ実装 (例: NAS アプライアンス)

> [!NOTE]
> SMB グローバル マッピングでは、Windows Server Version 1709 の DFS、DFSN、および DFSR 共有がサポートされていません。

## <a name="named-volumes"></a>名前付きボリューム

名前付きボリュームの機能を使用すると、名前を指定してボリュームを作成し、コンテナーに割り当てて、同じ名前で後で再利用できます。 作成時の実際のパスを追跡する必要はなく、名前だけを使用します。 Windows 上の Docker エンジンには、ローカル コンピューター上にボリュームを作成できる、組み込みの名前付きボリューム プラグインがあります。 複数のコンピューターで名前付きボリュームを使用する場合は、追加のプラグインが必要です。

手順の例:

1. `docker volume create unwound`-"アンワインド" という名前のボリュームを作成する
2. c:\data にマップされたボリュームを使用してコンテナーを `docker run -v unwound:c:\data microsoft/windowsservercore` 開始する
3. コンテナー内の c:\data にいくつかのファイルを書き込み、コンテナーを停止します。
4. `docker run -v unwound:c:\data microsoft/windowsservercore`-新しいコンテナーを開始します
5. 新しいコンテナー内で `dir c:\data` を実行します。ここにはまだファイルが含まれています。

> [!NOTE]
> Windows Server は、ターゲットパス名 (コンテナー内のパス) を小文字に変換します。`-v unwound:c:\MyData`、または Linux コンテナー内の `-v unwound:/app/MyData` の場合、`c:\mydata`のコンテナー内のディレクトリ、または Linux コンテナー内の `/app/mydata` は、マップされている (存在しない場合は作成された) ディレクトリになります。
